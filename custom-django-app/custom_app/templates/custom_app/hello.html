{% extends 'base.html' %}
{% load static %}
{% block content %}
<div>
<ul style="
    /* Center the content */
    align-items: center;
    display: flex;
    justify-content: center;

    /* Reset styles */
    list-style-type: none;
    margin: 0;
    padding: 0;
">
    <li style="
        /* Rounded border */
        border-radius: 9999px;
        height: 20px;
        width: 20px;

        /* Active dot */
        background-color: rgba(0, 0, 0, .3);

        /* Inactive dot */
        background-color: transparent;
        border: 1px solid rgba(0, 0, 0, .3);

        /* OPTIONAL: Spacing between dots */
        margin: 0 4px;
    " />
</div>

<!-- -->
 <!--   <div style="height:512px;position:relative;transform-style:preserve-3d;transition:transform 1s ease 0s">
        <div style="backface-visibility:hidden;height:100%;left:0;opacity:1;overflow:scroll;position:absolute;top:0;width:100%"> 
            <div style="align-items:center;display:flex;flex-direction:column;height:100%;justify-content:center;padding:8px">
                <ul style="align-items:center;display:flex;justify-content:center;list-style-type:none;margin:0;padding:0">
                    <li style="background-color:rgba(0,0,0,.3);border:none;border-radius:9999px;cursor:pointer;height:12px;margin:0 4px;width:12px"></li>
                    <li style="border:1px solid rgba(0,0,0,.3);border-radius:9999px;cursor:pointer;height:12px;margin:0 4px;width:12px"></li>
                    <li style="border:1px solid rgba(0,0,0,.3);border-radius:9999px;cursor:pointer;height:12px;margin:0 4px;width:12px"></li>
                    <li style="border:1px solid rgba(0,0,0,.3);border-radius:9999px;cursor:pointer;height:12px;margin:0 4px;width:12px"></li>
                </ul>
            </div>
  <!--      </div>
    </div> 
-->

    <!-- -->


<div class="main-content-wrapper">
    <main class="main-content">

<!-- add navigation dots here: use Scrollspy from bootstrap -->

<!-- class comes from bootstrap -->
        <div class="container-fluid">
            <h1>Rainfall Estimation</h1>

            <a href="url">Learn more </a> | <a href="url">Help </a>
            <!-- Adding a list of "Hello" greetings -->
            <div class="card">
                <div class="card-header">
                    Convert Level II Data to CfRadial (RadxConvert)
                </div>
                <div class="card-body">
                	Step 1: Choose data source
                    <!-- <a id="choose-data-source" href="#">Choose data source </a> -->
<br>

<div class="input-group mt-3 mb-3">
  <div class="input-group-prepend">
    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown">
      Data Sources
    </button>
    <div class="dropdown-menu">
      <a class="dropdown-item" id="stage1-file-filedir" href="#">File or Directory</a>
      <a class="dropdown-item" id="stage1-file-radar" href="#">Radar</a>
      <a class="dropdown-item" id="stage1-file-tutorial" href="#">Tutorial</a>
    </div>
  </div>
  <input type="text" class="form-control" uri="888" source=1 id ="stage1-file" placeholder="data/directory">
  <input type="text" class="form-control" uri="888" source=2 id ="stage1-radar-name" placeholder="radar name, e.g. KFTG">
  <div class="input-group-prepend" id="stage1-start-time-label">
      <span class="input-group-text">start time</span>
  </div>
  <input type="datetime-local" class="form-control" uri="888" source=2 id ="stage1-start-time" placeholder="start date time">
  <div class="input-group-prepend" id="stage1-end-time-label">
      <span class="input-group-text">stop time</span>
  </div>  
  <input type="datetime-local" class="form-control" uri="888" source=2 id ="stage1-end-time" placeholder="end date time"> 

</div>

<!--
  <div class="form-group">
    <label for="email"></label>
    <input type="email" class="form-control" value="rainfall/basic/raw/RCWF/20170602/20170602001300.raw" id="stage1-param-file" uri="888">
  </div>
-->
  <!-- NOTE: when setting value, also set the uri; initialize by setting value & uri when document.ready event -->

                    <br> 
                    <table class="table">
                    <thead>
                    <tr>
                    <th scope="col"></th>
                    <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody id="data-source-list">
                    </tbody>
                    </table>

                	Step 2: Setup parameter file
                    <!-- a id="setup-parameter-file" href="#">Setup parameter file </a> -->
                    <br>
  <div class="form-group">
    <label for="email"></label>
    <input type="email" class="form-control" value="tutorial/basic/params/RadxConvert.new" id="stage1-param-file" uri="888">
  </div>
                    <table class="table">
                    <thead>
                    <tr>
                	<th scope="col"></th>
                    <th scope="col"></th>
                    </tr>
                    <!-- <a href="url">Upload your parameter file </a> </th> -->
                    </thead>
                    <tbody id="parameter-file-list">
                    </tbody>
                    </table>


                    <!-- <select id="greeting-select"></select>  -->
                    <button id="run-radxconvert-button" class="btn btn-primary">Run</button>
                    <!-- <button id="test-variable-button" class="btn btn-primary">Print Var</button> -->
                </div>
            </div>
<!--
            <div class="card">

                <div id="demo" class="carousel slide" data-ride="carousel">

  <-- Indicators
  
  <ul class="carousel-indicators">
    <li data-target="#demo" data-slide-to="0" class="active"></li>
    <li data-target="#demo" data-slide-to="1"></li>
    <li data-target="#demo" data-slide-to="2"></li>
  </ul>
  
  <-- The slideshow 
  <div class="carousel-inner">
    <div class="carousel-item active">
      <img src="la.jpg" alt="Los Angeles" width="1100" height="500">
    </div>
    <div class="carousel-item">
      <img src="chicago.jpg" alt="Chicago" width="1100" height="500">
    </div>
    <div class="carousel-item">
      <img src="ny.jpg" alt="New York" width="1100" height="500">
    </div>
  </div>
  
  <-- Left and right controls 
  <a class="carousel-control-prev" href="#demo" data-slide="prev">
    <span class="carousel-control-prev-icon"></span>
  </a>
  <a class="carousel-control-next" href="#demo" data-slide="next">
    <span class="carousel-control-next-icon"></span>
  </a>
</div>

           </div> <-- card for carousel -->

           <!-- Displaying a list of recent experiments -->
            <div class="card">
                <div class="card-header">
                    Previous Conversions
                </div>
                <div class="card-body">
                    <button id="conversion-refresh-button" class="btn btn-secondary">Refresh</button>
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">Application</th>
                                <th scope="col">Status</th>
                                <th scope="col">Creation Time</th>
                                <th scope="col">OutDir</th>
                                <th scope="col">Log</th>
                                <th scope="col">Images</th>
                                <th scope="col">Next Stage</th>
                            </tr>
                        </thead>
                        <tbody id="experiment-list-conversion">
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- begin My Storage-->

<!--
            <div class="card" id="stage2optional">
                <div class="card-header">
                    Compute Beam Blockage (RadxBeamBlock)
                </div>
                <div class="card-body">
                    
                    <a href="url">Choose data source </a> <br>
                    
                    Set up parameter file <br>
                    <a href="url">Download template </a> <br>
                    <a href="url">Upload your parameter file </a> <br>
                    Output Data - NetCDF Cartesian rate data - view using (CIDD)
                    <button id="run-button" class="btn btn-primary">Run</button>
                </div>
            </div>   
            -->         

             <div class="card" id="stage2">
                <div class="card-header">
                    Map Rate to Surface (RadxRate)
                </div>
                <div class="card-body">
                    Step 1: Choose data source
                    <!-- <a id="choose-data-source" href="#">Choose data source </a> -->
<br>

<div class="input-group mt-3 mb-3">
  <div class="input-group-prepend">
    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown">
      Data Sources
    </button>
    <div class="dropdown-menu">
      <a class="dropdown-item" id="stage2-file-filedir" href="#">File or Directory</a>
      <a class="dropdown-item" id="stage2-file-tutorial" href="#">Tutorial</a>
    </div>
  </div>
  <input type="text" class="form-control" uri="888" source=1 id ="stage2-file" placeholder="data/directory">
</div>


                    Step 2: Setup parameter file
                    <!-- a id="setup-parameter-file" href="#">Setup parameter file </a> -->
                    <br>
  <div class="form-group">
    <label for="email"></label>
    <input type="email" class="form-control" value="tutorial/basic/params/RadxRate.new" id="stage2-param-file" uri="888">
  </div>


                    <!--
                	
                	<a href="url">Choose data source </a> <br>
                	
                	Set up parameter file <br>
                	<a href="url">Download template </a> <br>
                	<a href="url">Upload your parameter file </a> <br>


                     -->
                    <button id="run-button-stage2" class="btn btn-primary">Run</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Compute Something (RadxQpe)
                </div>
                <div class="card-body">
                	
                	<a href="url">Choose data source </a> <br>
                	
                	Set up parameter file <br>
                	<a href="url">Download template </a> <br>
                	<a href="url">Upload your parameter file </a> <br>
                	Output Data - NetCDF Cartesian rate data - view using (CIDD)


                    <!-- <select id="greeting-select"></select>  -->
                    <button id="run-button" class="btn btn-primary">Run</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Compute Rainfall Accumulation (RateAccum)
                </div>
                <div class="card-body">
                	
                	<a href="url">Choose data source </a> <br>
                	
                	Set up parameter file <br>
                	<a href="url">Download template </a> <br>
                	<a href="url">Upload your parameter file </a> <br>
                	Output Data - NetCDF Cartesian accumulated data - view using (CIDD)

                    <!-- <select id="greeting-select"></select>  -->
                    <button id="run-button" class="btn btn-primary">Run</button>
                </div>
            </div>
            <!-- -->

            <button id="run-button" class="btn btn-secondary">Exit</button>

            <!-- Displaying a list of recent experiments -->
            <div class="card">
                <div class="card-header">
                    Experiments
                </div>
                <div class="card-body">
                    <button id="refresh-button" class="btn btn-secondary">Refresh</button>
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">Application</th>
                                <th scope="col">Creation Time</th>
                                <th scope="col">Status</th>
                                <th scope="col">Output</th>
                            </tr>
                        </thead>
                        <tbody id="experiment-list">
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- begin My Storage-->

            <!-- Displaying a list of recent experiments -->
            <div class="card">
                <div class="card-header">
                    User Storage
                </div>
                <div class="card-body">
                    <!-- button id="refresh-button" class="btn btn-secondary">Refresh</button -->
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Directory</th>
                                <th scope="col">URL</th>
                                <th scope="col">Size</th>                                             
                            </tr>
                        </thead>
                        <tbody id="storage-dir-list">
                        </tbody>
                    </table>
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">File</th>
                                <th scope="col">dataProductURI</th>
                                <th scope="col">Mime Type</th>
                                <th scope="col">Size</th>                                             
                            </tr>
                        </thead>
                        <tbody id="storage-file-list">
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- begin My Storage-->

<div class="card">
<div class="card-header">
Choose data source
</div>
<div class="card-body">        
<div id="user-storage"/>

  </div>

  <script>
    // provide data for initializing api's session.Session
    window.AiravataPortalSessionData = {"username": "brenda92", "airavataInternalUserId": "brenda92@lrose", "isGatewayAdmin": true};
  </script>
  <!-- script type="text/javascript" src="/static/common/dist/js/chunk-vendors.7db780c7.js" ></script>
  <script type="text/javascript" src="/static/common/dist/js/app.faa7ad7b.js" ></script>
  
    <script type="text/javascript" src="/static/common/dist/js/notices.398e45d2.js" ></script>
  
  
<script type="text/javascript" src="/static/django_airavata_workspace/dist/js/chunk-vendors.e45ba37b.js" ></script>
<script type="text/javascript" src="/static/django_airavata_workspace/dist/js/chunk-common.18aeeebe.js" ></script>
<script type="text/javascript" src="/static/django_airavata_workspace/dist/js/user-storage.ecc9856a.js" ></script-->
</div>
</div>

<!-- end My Storage  -->

        </div>
    </main>
</div>
{% endblock content %}

{% block scripts %}

<script src="{% static 'django_airavata_api/dist/airavata-api.js' %}"></script>

<script>

    const { models, services, session, utils } = AiravataAPI;

    stage1_input_uri = "something wonderful";
    const TUTORIAL_ENUM = 1;
    const RADAR_ENUM = 2;
    const FILEDIR_ENUM = 3;

// https://gateway.lrose.net/api/user-storage/~/garbage_dump/
    function chooseDataSourceFile(path) {
        return services.UserStoragePathService.get({
            path,
        }).then(data => {
            $("#storage-dir-list").empty();
            data.directories.forEach((item, index) => {
                $("#storage-dir-list").append(
                    `<tr>
                            <td>${item.name}</td>
                            <td>${item.url}</td>
                            <td>${item.size}</td>
                        </tr>`
                );
            });
            $("#storage-file-list").empty();
            data.files.forEach((item, index) => {
                $("#storage-file-list").append(
                    `<tr>
                            <td>${item.name}</td>
                            <td>${item.dataProductURI}</td>

                            <td>${item.mimeType}</td>
                            <td>${item.size}</td>
                        </tr>`
                );
            });
        });    
    };

    function chooseDataSourceDate() {
        console.log("inside chooseDataSource");
                $("#data-source-list").append(
                    `<tr>
                            <td><form>
                                 <label for="fname">Start date/time</label>
                                 <input type="text" id="fname" name="fname"><br>
                                 <label for="lname">End data/time</label>
                                 <input type="text" id="lname" name="lname"><br>
                                 <label for="lname">Radar</label>
                                 <input type="text" id="radar-name" name="lname">
                            </form></td>
                            <td>radar</td>
                        </tr>`
                );
    };

     function chooseDataSource() {
        console.log("inside chooseDataSource");
                $("#data-source-list").empty();
                $("#data-source-list").append(
                    ` 
  <input type="radio" id="stage1-default" name="gender" value="default">
  <label for="default">Default</label><br>
  <input type="radio" id="stage1-radar" name="gender" value="radar">
  <label for="radar">Radar</label><br>
  <input type="radio" id="stage1-file" name="file" value="file">
  <label for="other">File</label><br><br>
                   `
            
                );
                  //  `<tr><td> <a id="by-default" href="#">Default </a></td> </tr>
                  //   <tr><td> <a id="by-radar" href="#"> By Radar </a></td> </tr>
                  //   <tr><td> <a id="by-file" href="#">File </a></td></tr>`
    };   

    function chooseParameterFile() {
        console.log("inside chooseParameterFile");
                $("#parameter-file-list").empty();
                $("#parameter-file-list").append(
                    `<tr><td> <a id="by-default" href="#set-stage1-input-default">Default </a></td> </tr>
                     <tr><td> <a id="by-file" href="#">File </a></td></tr>`
                );
    }; 

    function printArgs() {
        stage1_input_uri = "beautiful";
        console.log(stage1_input_uri);
    };

    // chooseDataSource();
    // $("#choose-data-source").click(chooseDataSource("~/garbage_dump")); 
    //$("#choose-data-source").click(function() {chooseDataSource(); return false;});  
    $(document).ready(function() {
       $("#choose-data-source").click(function() {chooseDataSource()});  
    });
    $(document).ready(function() {
       $("#setup-parameter-file").click(function() {chooseParameterFile()});  
    });
    $(document).ready(function() {
       $("#set-stage1-input-default").click(function() {printArgs()});  
    });

    const default_stage1_data_file_uri = "airavata-dp://bc297ca4-5d28-4f84-9647-08ab1af9dd64";
    const default_stage1_param_file_uri = "airavata-dp://42d4e0c2-3969-4d69-a735-0bc0d7caca52";

    function setStage1Tutorial() {
       $("#stage1-file").show();  
       $("#stage1-radar-name").hide();  
       $("#stage1-start-time").hide();  
       $("#stage1-end-time").hide(); 
       $("#stage1-start-time-label").hide();  
       $("#stage1-end-time-label").hide();
       $("#stage1-file").val("tutorial/basic/raw/RCWF/20170602/20170602001300.raw");  
       $("#stage1-file").attr("source", TUTORIAL_ENUM); 
       $("#stage1-param-file").val("tutorial/basic/params/RadxConvert.new");  
       //$("#stage1-param-file").attr("uri", default_stage1_param_file_uri);        
       // $(`#stage1-file`).attr("uri")
    };

    // if selecting Radar as input source, then change to start/end time & radar name
    // also switch the default parameter file to the NEXRAD form 
    function setStage1Radar() {
        // TODO: change the input boxes to time and radar name
       $("#stage1-file").hide();  
       $("#stage1-file").attr("source", RADAR_ENUM); 
       $("#stage1-radar-name").show();  
       $("#stage1-start-time").show();  
       $("#stage1-end-time").show();  
       $("#stage1-start-time-label").show();  
       $("#stage1-end-time-label").show();
       $("#stage1-param-file").val("default/params/RadxConvert.nexrad");  
    };

    function setStage2Tutorial() {
       $("#stage2-file").val("tutorial/basic/convert/RCWF/20170602/20170602001300.nc");  
       $("#stage2-file").attr("source", TUTORIAL_ENUM); 
       $("#stage2-param-file").val("tutorial/basic/params/RadxRate.new");  
       //$("#stage1-param-file").attr("uri", default_stage1_param_file_uri);        
       // $(`#stage1-file`).attr("uri")
    };
 
    $(document).ready(function() {setStage1Tutorial()});
    //
     //  $("#stage1-file").val("rainfall/basic/raw/RCWF/20170602/20170602001300.raw");  
     //  //$("#stage1-file").attr("uri", default_stage1_data_file_uri); 
     //  $("#stage1-param-file").val("rainfall/basic/params/RadxConvert.new");  
     //  //$("#stage1-param-file").attr("uri", default_stage1_param_file_uri);        
     //  // $(`#stage1-file`).attr("uri")
    //});

    $(document).ready(function() {
       $("#stage1-file-tutorial").click(function() {setStage1Tutorial()}); 
       $("#stage1-file-radar").click(function()    {setStage1Radar()});  
    });
    $(document).ready(function() {
       $("#stage2-file-tutorial").click(function() {setStage2Tutorial()});  
    });    

    const appInterfaceId = "RadxConvert_0d6e7a6a-8c70-49d5-8cd2-f00091e42559";
//      "nexrad_display_4837fe51-7c52-426e-963d-f2c32d699947"; 
    const stage2AppInterfaceId = "precip_stage2_0e0c14cb-d094-4e13-a633-4d4248058b7c";

    const stage1AppInterfaceId = "RadxConvert_display_c814c263-ab5d-4e97-b10f-3a5295420487";



    function loadExperiments() {
        return services.ExperimentSearchService.list({
            limit: 5,
            [models.ExperimentSearchFields.USER_NAME.name]:
                session.Session.username,
            [models.ExperimentSearchFields.APPLICATION_ID.name]: stage2AppInterfaceId
        }).then(data => {
            $("#experiment-list").empty();
            data.results.forEach((exp, index) => {
                $("#experiment-list").append(
                    `<tr>
                            <td>${exp.name}</td>
                            <td>${exp.executionId}</td>
                            <td>${exp.creationTime}</td>
                            <td>${exp.experimentStatus.name}</td>
                            <td id="output_${index}"></td>
                        </tr>`
                );
                // If experiment has finished, load full details, then parse the stdout file
                if (exp.experimentStatus === models.ExperimentState.COMPLETED) {
                    services.FullExperimentService.retrieve({
                        lookup: exp.experimentId
                    })
                        .then(fullDetails => {
                            console.log('here 1');
                            const stdoutDataProductId = fullDetails.experiment.experimentOutputs.find(
                                o => o.name === "Standard-Out"
                            ).value;  // TODO: getting an error here ... 
                            // here 1
// url:491 Uncaught (in promise) TypeError: Cannot read property 'value' of undefined
//    at url:491
                            const stdoutDataProduct = fullDetails.outputDataProducts.find(
                                dp => dp.productUri === stdoutDataProductId
                            );
                            if (
                                stdoutDataProduct &&
                                stdoutDataProduct.downloadURL
                            ) {
                                console.log('here 2');
                                return fetch(stdoutDataProduct.downloadURL, {
                                    credentials: "same-origin"
                                }).then(result => result.text());
                            }
                        })
                        .then(text => {
                            $(`#output_${index}`).text(text);
                            // $('#ItemPreview').attr('src', `data:image/png;base64,${yourByteArrayAsBase64}`);
                        });
                }
            });
        });
    }

    loadExperiments();
    $("#refresh-button").click(loadExperiments);

    function populateStage2(processDirName) {
        alert(processDirName);
        //parameter-file-stage2 
        //     data-source-stage2
        // update the Run button to use the processDirName  
                            if (
                                processDirName 
                            ) {

                                $("#run-button-stage2").click(function() { 
                                    runStage2(processDirName);
                                });                                
                                //$(`#continue_${index}`).on("click", function() { alert(processDirName);});
                            }

    }

    function runStage2(processDirName) {
        console.log('entering runStage2');
        // TODO: populate the inputs to the next stage with the info from the processDirName,
        // or maybe the experiementID??
        // then when "Run" is clicked, send the processDirName as argument.
        const step = "stage2"; // $("#greeting-select").val();
        //const data_file_uri = "\"2020 09 29 12 00 00\"";
        //const param_file_uri = "\"2020 09 29 12 10 00\"";
        const data_file_uri = "airavata-dp://bc297ca4-5d28-4f84-9647-08ab1af9dd64";
        const param_file_uri = "airavata-dp://42d4e0c2-3969-4d69-a735-0bc0d7caca52";
        //const radar_name = "KFTG";
        const loadAppInterface = services.ApplicationInterfaceService.retrieve({lookup: stage2AppInterfaceId});
// TODO: get the id of the RadxConvert_display application
        //const appDeploymentId = "lrose-vc.jetstream-cloud.org_nexrad_display_a6ceaf23-4a54-4f03-9c69-bdd0a8dcf21d";
        const appDeploymentId = "lrose-vc.jetstream-cloud.org_RadxConvert_display_dbba2d50-4949-40f1-a0eb-fca71df8ec37";
        const loadQueues = services.ApplicationDeploymentService.getQueues({ lookup: appDeploymentId });

        const resourceHostId = "lrose-vc.jetstream-cloud.org_d785f302-592b-45e7-9907-c06b31631592"; 
        const queueName = "cloud";
        const groupResourceProfileId = "621cdb88-33b4-47ee-953d-ee31d9cd2012";
        const loadWorkspacePrefs = services.WorkspacePreferencesService.get();
        Promise.all([loadAppInterface, loadWorkspacePrefs, loadQueues])
        .then(([appInterface, workspacePrefs, queues]) => {
            const experiment = appInterface.createExperiment();
            experiment.experimentName = "precip " + step;
            experiment.projectId = workspacePrefs.most_recent_project_id;
            const cloudQueue = queues.find(q => q.queueName === queueName);
            experiment.userConfigurationData.groupResourceProfileId = groupResourceProfileId;
            experiment.userConfigurationData.computationalResourceScheduling.resourceHostId = resourceHostId;
            experiment.userConfigurationData.computationalResourceScheduling.totalCPUCount = cloudQueue.defaultCPUCount;
            experiment.userConfigurationData.computationalResourceScheduling.nodeCount = cloudQueue.defaultNodeCount;
            experiment.userConfigurationData.computationalResourceScheduling.wallTimeLimit = cloudQueue.defaultWalltime;
            experiment.userConfigurationData.computationalResourceScheduling.queueName = queueName;
            // Copy the selected greeting to the value of the first input
            experiment.experimentInputs[0].value = processDirName;  // TODO: this needs to be a list; comma separated list
            experiment.experimentInputs[1].value = param_file_uri; // TODO: make this 1st parameter
            //experiment.experimentInputs[2].value = radar_name;

            return services.ExperimentService.create({data: experiment});
        }).then(exp => {
            return services.ExperimentService.launch({lookup: exp.experimentId});
        })
    };

    function some_function(processDirName) {
        return new Promise(function(resolve, reject) {
            let x = 0;

            if (x == 0) {
               resolve(alert(processDirName));
            } else {
               reject(alert("It broke"));
           }
        });
    };

    function loadRadxConversionExperiments() {
        return services.ExperimentSearchService.list({
            limit: 7,
            [models.ExperimentSearchFields.USER_NAME.name]:
                session.Session.username,
            [models.ExperimentSearchFields.APPLICATION_ID.name]: stage1AppInterfaceId
        }).then(data => {
            $("#experiment-list-conversion").empty();
            data.results.forEach((exp, index) => {
                $("#experiment-list-conversion").append(
                    `<tr>
                            <td>${exp.name}</td>
                            <td>${exp.executionId}</td>
                            <td>${exp.experimentStatus.name}</td>
                            <td>${exp.creationTime}</td>
                            <td id="outdir_${index}"></td>
                            <td id="log_${index}">
                            <a href="url">view log file </a> </td>
                            <td id="image3_${index}">
                              <img id="image_${index}" src="" alt="Gucci" width="50" height="50"> </td>
                            <td>
                            <a href="#stage2" id="continue_${index}">Continue</button>
                             </td>
                        </tr>`

                        // <a href="#stage2">continue next step </a>

                        // <a rel="nofollow" href="http"
                        //    <a rel="${exp.processDirName}" href="#stage2">continue next step </a> </td>

                );
                // TODO: the url for continue needs to have the experimentId 
                //       the url would be the next step card, 
                // If experiment has finished, load full details, then parse the stdout file
                if (exp.experimentStatus === models.ExperimentState.COMPLETED) {
                    services.FullExperimentService.retrieve({
                        lookup: exp.experimentId
                    })
                        //.then(fullDetails => {
                        //    console.log('here 11');
                        //    const stdoutDataProductId = fullDetails.experiment.experimentOutputs.find(
                        //        o => o.name === "Output-Dir"
                        //    ).value;  
                        //    const stdoutDataProduct = fullDetails.outputDataProducts.find(
                        //        dp => dp.productUri === stdoutDataProductId
                        //    );
                        //    if (
                        //        stdoutDataProduct &&
                        //        stdoutDataProduct.downloadURL
                        //    ) {
                        //        console.log('here 12');
                        //        return stdoutDataProductId.name;
                        //        //return fetch(stdoutDataProduct.downloadURL, {
                        //        //    credentials: "same-origin"
                        //        //}).then(result => result.text());
                        //    }
                        //})
                        .then(fullDetails => {
                            console.log('here 1111');
                            const processDirName = fullDetails.experiment.processes[0].processId; 
                            if (
                                processDirName 
                            ) {
                                console.log('here 1112');
                                $(`#outdir_${index}`).text(processDirName);
                                $(`#continue_${index}`).on("click", function() { 
                                    populateStage2(processDirName);
                                });                                
                                //$(`#continue_${index}`).on("click", function() { alert(processDirName);});
                            }
                            console.log('here 111');
                            const outdirDataProductId = fullDetails.experiment.experimentOutputs.find(
                                o => o.name === "Images" // TODO: what is the name of the image dir?
                            ).value; 
                            // TODO: need to parse the outdirDataProductId because it is a comma separated list
                            const imageArray = outdirDataProductId.split(',');
                            const firstOne = imageArray[0]; // "airavata-dp://14be7773-e2f5-4e1b-8349-75bb6f674af1"; // outdirDataProductId[0];
                            const outdirDataProduct = fullDetails.outputDataProducts.find(
                                dp => dp.productUri === firstOne
                            );
                            if (
                                outdirDataProduct &&
                                outdirDataProduct.downloadURL
                            ) {
                                console.log("index=" + index + " here ... Have downloadURL");
                                console.log(outdirDataProduct.downloadURL);
                                $(`#image_${index}`).attr('src', outdirDataProduct.downloadURL); // .show();
                        
                        //        return stdoutDataProductId.name;
                                //return fetch(outdirDataProduct.downloadURL, {
                                //    credentials: "same-origin"
                                //}).then(result => result.text());   
                            }
//                        })
//                        .then(text => {
//                                console.log('here 112');
//                                //console.log(text);
//                        //        $(`#outdir_${index}`).text(outdirDataProductId);
//                                const testOutputProductId = "airavata-dp://14be7773-e2f5-4e1b-8349-75bb6f674af1";
 //                               //const imgsrc = "data:image/png;base64," + text; // btoa(String.fromCharCode.apply(null, text);
 //                               if (text) {
//
//                                  console.log("index=" + index + " if (text) is true, setting the image src");
//
//                                  //$(`#image_${index}`).attr('src', text); // .show();
//                                } else {
//                                    console.log("if (text) is false");
//                                }
//                        //        //return fetch(stdoutDataProduct.downloadURL, {
//                        //        //    credentials: "same-origin"
//                        //        //}).then(result => result.text());
                        });
                        //})
                        //.then(fullDetails => {

                        //});
                        // .catch(alert("Problem fetching previous experiments")); 
                        //.then(text => {
                        //    //$(`#continue_${index}`).text(text);
                        //    $(`#continue_${index}`).click(function() {
                        ////       alert(exp.processes.processId);
                        //        alert(exp.experimentId);
                        //    })
                        //});
                }
            });
        });
    }    

    //$("#continue_*").click(???)

    loadRadxConversionExperiments();
    $("#conversion-refresh-button").click(loadRadxConversionExperiments);

    $("#test-variable-button").click(e => {
        console.log("value of paramter is ");
        console.log($(`#stage1-file`).val());
        console.log($(`#stage1-file`).attr("uri"));
    });

    $("#run-radxconvert-button").click(e => {
        const step = "RadxConvert"; // $("#greeting-select").val();
        //const data_file_uri = "\"2020 09 29 12 00 00\"";
        //const param_file_uri = "\"2020 09 29 12 10 00\"";
        const data_file_source = $(`#stage1-file`).attr("source");
        const radar_name = $(`#stage1-radar-name`).val();
        const start_time = $(`#stage1-start-time`).val();
        const end_time = $(`#stage1-end-time`).val();   
        console.log("data_file_source: " + data_file_source); 
        console.log("radar name: " + radar_name); 
        console.log("start time: " + start_time); 
        console.log("end time: " + end_time);                     
        const data_file_uri = $(`#stage1-file`).attr("uri");
        // "airavata-dp://bc297ca4-5d28-4f84-9647-08ab1af9dd64";
        const param_file_uri = $(`#stage1-param-file`).attr("uri")
        // "airavata-dp://42d4e0c2-3969-4d69-a735-0bc0d7caca52";
        //const radar_name = "KFTG";
        // We need the app interface to be the same, so we can retrieve all related experiements;
        // We will need to send different parameters based on the data_file_source

        const loadAppInterface = services.ApplicationInterfaceService.retrieve({lookup: stage1AppInterfaceId});

// TODO: get the id of the RadxConvert_display application
        //const appDeploymentId = "lrose-vc.jetstream-cloud.org_nexrad_display_a6ceaf23-4a54-4f03-9c69-bdd0a8dcf21d";
        const appDeploymentId = "lrose-vc.jetstream-cloud.org_RadxConvert_display_dbba2d50-4949-40f1-a0eb-fca71df8ec37";
        const loadQueues = services.ApplicationDeploymentService.getQueues({ lookup: appDeploymentId });

        const resourceHostId = "lrose-vc.jetstream-cloud.org_d785f302-592b-45e7-9907-c06b31631592"; 
        const queueName = "cloud";
        const groupResourceProfileId = "621cdb88-33b4-47ee-953d-ee31d9cd2012";
        const loadWorkspacePrefs = services.WorkspacePreferencesService.get();
        Promise.all([loadAppInterface, loadWorkspacePrefs, loadQueues])
        .then(([appInterface, workspacePrefs, queues]) => {
            const experiment = appInterface.createExperiment();
            experiment.experimentName = "workflow " + step;
            experiment.projectId = workspacePrefs.most_recent_project_id;
            const cloudQueue = queues.find(q => q.queueName === queueName);
            experiment.userConfigurationData.groupResourceProfileId = groupResourceProfileId;
            experiment.userConfigurationData.computationalResourceScheduling.resourceHostId = resourceHostId;
            experiment.userConfigurationData.computationalResourceScheduling.totalCPUCount = cloudQueue.defaultCPUCount;
            experiment.userConfigurationData.computationalResourceScheduling.nodeCount = cloudQueue.defaultNodeCount;
            experiment.userConfigurationData.computationalResourceScheduling.wallTimeLimit = cloudQueue.defaultWalltime;
            experiment.userConfigurationData.computationalResourceScheduling.queueName = queueName;
            // Copy the selected greeting to the value of the first input
            // TODO: send args based on data_file_source; select stage1AppInterfaceId based on data_file_source
            experiment.experimentInputs[0].value = data_file_source;    
            experiment.experimentInputs[1].value = radar_name;  
            experiment.experimentInputs[2].value = start_time; // TODO: make this 1st parameter
            experiment.experimentInputs[3].value = end_time;
//            experiment.experimentInputs[2].value = param_file_uri; // TODO: make this 1st parameter


            return services.ExperimentService.create({data: experiment});
        }).then(exp => {
            return services.ExperimentService.launch({lookup: exp.experimentId});
        })
    });



    $("#run-stage2-button").click(e => {
        const step = "stage2"; // $("#greeting-select").val();
        //const data_file_uri = "\"2020 09 29 12 00 00\"";
        //const param_file_uri = "\"2020 09 29 12 10 00\"";
        const data_file_uri = "airavata-dp://bc297ca4-5d28-4f84-9647-08ab1af9dd64";
        const param_file_uri = "airavata-dp://42d4e0c2-3969-4d69-a735-0bc0d7caca52";
        //const radar_name = "KFTG";
        const loadAppInterface = services.ApplicationInterfaceService.retrieve({lookup: stage2AppInterfaceId});
// TODO: get the id of the RadxConvert_display application
        //const appDeploymentId = "lrose-vc.jetstream-cloud.org_nexrad_display_a6ceaf23-4a54-4f03-9c69-bdd0a8dcf21d";
        const appDeploymentId = "lrose-vc.jetstream-cloud.org_precip_stage2_3f37c217-4a4e-4031-871f-13a054123c26";
        const loadQueues = services.ApplicationDeploymentService.getQueues({ lookup: appDeploymentId });

        const resourceHostId = "lrose-vc.jetstream-cloud.org_d785f302-592b-45e7-9907-c06b31631592"; 
        const queueName = "cloud";
        const groupResourceProfileId = "621cdb88-33b4-47ee-953d-ee31d9cd2012";
        const loadWorkspacePrefs = services.WorkspacePreferencesService.get();
        Promise.all([loadAppInterface, loadWorkspacePrefs, loadQueues])
        .then(([appInterface, workspacePrefs, queues]) => {
            const experiment = appInterface.createExperiment();
            experiment.experimentName = "precip " + step;
            experiment.projectId = workspacePrefs.most_recent_project_id;
            const cloudQueue = queues.find(q => q.queueName === queueName);
            experiment.userConfigurationData.groupResourceProfileId = groupResourceProfileId;
            experiment.userConfigurationData.computationalResourceScheduling.resourceHostId = resourceHostId;
            experiment.userConfigurationData.computationalResourceScheduling.totalCPUCount = cloudQueue.defaultCPUCount;
            experiment.userConfigurationData.computationalResourceScheduling.nodeCount = cloudQueue.defaultNodeCount;
            experiment.userConfigurationData.computationalResourceScheduling.wallTimeLimit = cloudQueue.defaultWalltime;
            experiment.userConfigurationData.computationalResourceScheduling.queueName = queueName;
            // Copy the selected greeting to the value of the first input
            experiment.experimentInputs[0].value = data_file_uri;  // TODO: this needs to be a list; comma separated list
            experiment.experimentInputs[1].value = param_file_uri; // TODO: make this 1st parameter
            //experiment.experimentInputs[2].value = radar_name;

            return services.ExperimentService.create({data: experiment});
        }).then(exp => {
            return services.ExperimentService.launch({lookup: exp.experimentId});
        })
    });

    $("#run-button").click(e => {
        const greeting = "something"; // $("#greeting-select").val();
        const start_time = "\"2020 09 29 12 00 00\"";
        const end_time = "\"2020 09 29 12 10 00\"";
        const radar_name = "KFTG";
        const loadAppInterface = services.ApplicationInterfaceService.retrieve({lookup: stage1AppInterfaceId});

        const appDeploymentId = "lrose-vc.jetstream-cloud.org_nexrad_display_a6ceaf23-4a54-4f03-9c69-bdd0a8dcf21d";
        const loadQueues = services.ApplicationDeploymentService.getQueues({ lookup: appDeploymentId });

        const resourceHostId = "lrose-vc.jetstream-cloud.org_d785f302-592b-45e7-9907-c06b31631592"; 
        const queueName = "cloud";
        const groupResourceProfileId = "621cdb88-33b4-47ee-953d-ee31d9cd2012";
        const loadWorkspacePrefs = services.WorkspacePreferencesService.get();
        Promise.all([loadAppInterface, loadWorkspacePrefs, loadQueues])
        .then(([appInterface, workspacePrefs, queues]) => {
            const experiment = appInterface.createExperiment();
            experiment.experimentName = "workflow " + greeting;
            experiment.projectId = workspacePrefs.most_recent_project_id;
            const cloudQueue = queues.find(q => q.queueName === queueName);
            experiment.userConfigurationData.groupResourceProfileId = groupResourceProfileId;
            experiment.userConfigurationData.computationalResourceScheduling.resourceHostId = resourceHostId;
            experiment.userConfigurationData.computationalResourceScheduling.totalCPUCount = cloudQueue.defaultCPUCount;
            experiment.userConfigurationData.computationalResourceScheduling.nodeCount = cloudQueue.defaultNodeCount;
            experiment.userConfigurationData.computationalResourceScheduling.wallTimeLimit = cloudQueue.defaultWalltime;
            experiment.userConfigurationData.computationalResourceScheduling.queueName = queueName;
            // Copy the selected greeting to the value of the first input
            experiment.experimentInputs[0].value = start_time;
            experiment.experimentInputs[1].value = end_time;
            experiment.experimentInputs[2].value = radar_name;

            return services.ExperimentService.create({data: experiment});
        }).then(exp => {
            return services.ExperimentService.launch({lookup: exp.experimentId});
        })
    });

    </script>

{% endblock scripts %}


